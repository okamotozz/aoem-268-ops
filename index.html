<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>排班表</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .wrap { max-width: 800px; margin: auto; }
  .timeslot { padding: 8px; border: 1px solid #ccc; margin: 4px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
  .timeslot.used { background-color: #e0e0e0; }
  #announcement { background:#fff3c6; padding:10px; border-radius:6px; margin-bottom:10px; cursor:default; }
</style>
</head>
<body>
<div class="wrap">

  <!-- 公告區 -->
  <div id="announcement">歡迎使用排班表</div>

  <!-- 名字輸入 -->
  <input type="text" id="username" placeholder="輸入名字">
  <input type="text" id="password" placeholder="密碼（選填）">
  <button id="submitBtn">確認選擇</button>

  <!-- 時段列表 -->
  <div id="timeslots"></div>

  <!-- 管理員模式示範 -->
  <a href="?admin=123">管理員模式</a>

</div>

<!-- 常駐文字 -->
<div style="text-align:center; margin-top:20px; font-size:12px; color:#888;">
  網頁表單製作者：DarkIrene
</div>

<script>
// ====== Firebase 初始化 ======
const firebaseConfig = {
  apiKey: "你的APIKEY",
  authDomain: "你的DOMAIN",
  databaseURL: "你的DBURL",
  projectId: "你的PROJECTID",
  storageBucket: "你的BUCKET",
  messagingSenderId: "你的SENDERID",
  appId: "你的APPID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====== 變數 ======
const urlParams = new URLSearchParams(window.location.search);
const isAdmin = urlParams.get("admin") === "123"; // 管理員密碼示範
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const submitBtn = document.getElementById("submitBtn");
const timeslotsDiv = document.getElementById("timeslots");
const announcementDiv = document.getElementById("announcement");

// ====== 公告功能 ======
// 讀取公告
db.ref("announcement").on("value", snap => {
  announcementDiv.innerText = snap.val() || "歡迎使用排班表";
});
// 管理員編輯公告
if (isAdmin){
  announcementDiv.style.cursor = "pointer";
  announcementDiv.title = "點擊編輯公告";
  announcementDiv.onclick = async () => {
    const newText = prompt("請輸入新的公告文字：", announcementDiv.innerText);
    if(newText!==null){
      await db.ref("announcement").set(newText);
    }
  }
}

// ====== 範例時段列表 ======
const times = ["09:00-10:00","10:00-11:00","11:00-12:00","13:00-14:00","14:00-15:00"];
// 顯示時段
function renderTimeslots(){
  timeslotsDiv.innerHTML = "";
  db.ref("timeslots").once("value").then(snapshot=>{
    const data = snapshot.val() || {};
    times.forEach(t=>{
      const slotDiv = document.createElement("div");
      slotDiv.className="timeslot";
      slotDiv.innerHTML = `<span>${t}</span>`;
      
      let btn = document.createElement("button");
      const now = new Date();
      const hour = parseInt(t.split(":")[0]);
      const slotDate = new Date(); slotDate.setHours(hour,0,0,0);
      const expired = now>slotDate; // 判斷時段過期

      if(data[t] && data[t].username){
        slotDiv.classList.add("used");
        slotDiv.innerHTML+=` <span>${data[t].username}</span>`;
        if(isAdmin){
          btn.textContent="刪除使用者";
          btn.onclick=()=>{ db.ref(`timeslots/${t}`).set({}); }
          slotDiv.appendChild(btn);
        }
      }else if(!expired){
        btn.textContent="選擇";
        btn.onclick = ()=>{
          const name = usernameInput.value.trim();
          const pwd = passwordInput.value.trim();
          if(!name){ alert("請輸入名字"); return; }
          db.ref(`timeslots/${t}`).get().then(snap=>{
            const slot = snap.val()||{};
            if(slot.username && !isAdmin){ alert("已被安排"); return; }
            db.ref(`timeslots/${t}`).set({username:name,password:pwd});
          });
        }
        slotDiv.appendChild(btn);
      }else{
        slotDiv.innerHTML+=" <span>已過期</span>";
      }
      timeslotsDiv.appendChild(slotDiv);
    });
  });
}

// 監聽時段更新
db.ref("timeslots").on("value", renderTimeslots);

// 初始渲染
renderTimeslots();
</script>
</body>
</html>
