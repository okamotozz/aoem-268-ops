<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>268å®˜è·æ’ç¨‹è¡¨</title>
<style>
body { font-family:"Microsoft JhengHei", sans-serif; background:#f6f6fa; padding:20px; position:relative; }
.wrap { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:relative; }
.slot { background:#f0f3ff; border-radius:8px; padding:10px; margin:4px 0; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.slot.taken { background:#ffe5e5; color:#555; }
.date-title { font-weight:bold; margin-top:20px; background:#e8e8ff; padding:6px; border-radius:6px; }
.admin-btn { background:#ffcccc; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; margin-left:4px; }
.danger-btn { background:#ff7777; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; margin-top:10px; }
.done-span { margin-left:8px; font-weight:bold; }
input,button,select,textarea { padding:8px; margin:4px; }
.pwd-span { margin-left:8px; color:#555; font-style:italic; }

#adminLoginBtn { position:absolute; top:20px; right:20px; background:#ffcc80; border:none; border-radius:8px; padding:6px 12px; cursor:pointer; font-size:14px; }
#adminLoginInputs { position:absolute; top:50px; right:20px; background:#fff; padding:10px; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,0.2); display:none; }

#admin { margin-top:20px; background:#fff6e0; padding:10px; border-radius:8px; display:none; }
</style>
</head>
<body>
<div class="wrap">
  <h2>268å®˜è·æ’ç¨‹è¡¨</h2>

  <!-- ç®¡ç†è€…ç™»å…¥æŒ‰éˆ• -->
  <button id="adminLoginBtn">ç®¡ç†è€…ç™»å…¥</button>
  <div id="adminLoginInputs">
    <input id="adminUser" placeholder="å¸³è™Ÿ">
    <input id="adminPass" type="password" placeholder="å¯†ç¢¼">
    <button id="adminSubmitBtn">ç™»å…¥</button>
  </div>

  <!-- å…¬å‘Š -->
  <div id="announcementArea" style="margin:20px 0; padding:10px; background:#fff3e0; border-radius:8px;">
    <h3>å…¬å‘Š</h3>
    <div id="announcementText" style="white-space:pre-wrap; color:#333;">è¼‰å…¥ä¸­...</div>
    <div id="announcementAdmin" style="margin-top:10px; display:none;">
      <textarea id="announcementInput" rows="3" style="width:100%; padding:6px;"></textarea>
      <button id="saveAnnouncement" style="margin-top:6px; padding:6px 12px; border-radius:6px; background:#ffcc80; border:none; cursor:pointer;">å„²å­˜å…¬å‘Š</button>
    </div>
  </div>

  <!-- ä½¿ç”¨è€… -->
  <div>
    <input id="name" placeholder="è«‹è¼¸å…¥ä½ çš„éŠæˆ²åç¨±">
  </div>
  <div>
    <input id="password" placeholder="å¯†ç¢¼é¸å¡«" type="password">
  </div>
  <button id="refresh">ç¢ºèªéŠæˆ²åç¨±</button>

  <!-- å®˜è·é¸æ“‡ -->
  <div style="margin-top:10px;">
    <label>é¸æ“‡éœ€è¦çš„å®˜è·ï¼š</label>
    <select id="scheduleSelect"></select>
  </div>

  <!-- é¡¯ç¤ºæ‰€æœ‰æ™‚æ®µ -->
  <div id="slots"></div>

  <!-- ç®¡ç†å“¡å°ˆå€ -->
  <div id="admin">
    <h3>ç®¡ç†å“¡å°ˆå€</h3>
    <input id="day" type="date">
    <input id="start" type="number" placeholder="é–‹å§‹å°æ™‚ (0-23)">
    <input id="end" type="number" placeholder="çµæŸå°æ™‚ (1-24)">

    <!-- å®˜è·ä¸‹æ‹‰é¸å–® + è‡ªè¨‚è¼¸å…¥ -->
    <select id="scheduleSelectAdmin">
      <option value="å¤§ç¥­å¸ï¼ˆå»ºé€ åŠ é€Ÿï¼‰">å¤§ç¥­å¸ï¼ˆå»ºé€ åŠ é€Ÿï¼‰</option>
      <option value="è³¢è€…ï¼ˆç ”ç©¶åŠ é€Ÿï¼‰">è³¢è€…ï¼ˆç ”ç©¶åŠ é€Ÿï¼‰</option>
      <option value="æˆ°è¡“å¤§å¸«ï¼ˆçˆ†å…µï¼‰">æˆ°è¡“å¤§å¸«ï¼ˆçˆ†å…µï¼‰</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>
    <input id="scheduleOtherInput" placeholder="è«‹è¼¸å…¥å…¶ä»–å®˜è·åç¨±" style="display:none;">

    <button id="make">å»ºç«‹æ™‚æ®µ</button>
    <br><br>
    <label>é¸æ“‡å®˜è·åˆªé™¤æ•´å€‹ç­è¡¨ï¼š</label>
    <select id="deleteScheduleSelect"></select>
    <button id="deleteSchedule" class="danger-btn">ğŸ—‘ï¸ åˆªé™¤æ•´å€‹å®˜è·</button>
  </div>
</div>

<div style="text-align:center; margin-top:20px; font-size:12px; color:#888;">
  ç¶²é ä½œè€…ï¼šDarkIrene
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const firebaseConfig = {
    apiKey: "AIzaSyBqUOjnXN-bp7OXJoQevS9-c0pnZxRU_B0",
    authDomain: "test-d07d4.firebaseapp.com",
    databaseURL: "https://test-d07d4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "test-d07d4",
    storageBucket: "test-d07d4.firebasestorage.app",
    messagingSenderId: "442419315645"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let isAdmin = false;
  const ADMIN_HASH = "5eae3c96460e5cf99a1b52a9aa12156e5b6190e44566a7e69ce79195d01db7c0";

  const announcementRef = db.ref("announcement");

  async function loadAnnouncement() {
    const snap = await announcementRef.get();
    const text = snap.val() || "ç›®å‰æ²’æœ‰å…¬å‘Š";
    document.getElementById("announcementText").innerHTML = text;
    document.getElementById("announcementAdmin").style.display = isAdmin ? "block" : "none";
    if(isAdmin) document.getElementById("announcementInput").value = text;
  }
  loadAnnouncement();

  document.getElementById("saveAnnouncement").onclick = async ()=> {
    const text = document.getElementById("announcementInput").value.trim();
    await announcementRef.set(text);
    alert("âœ… å…¬å‘Šå·²æ›´æ–°ï¼");
    loadAnnouncement();
  };

  // ===== ç®¡ç†è€…ç™»å…¥æŒ‰éˆ• =====
  const loginBtn = document.getElementById("adminLoginBtn");
  const loginInputs = document.getElementById("adminLoginInputs");
  const submitBtn = document.getElementById("adminSubmitBtn");

  // æª¢æŸ¥ localStorage
  if(localStorage.getItem("isAdmin") === "true"){
    isAdmin = true;
    document.getElementById("admin").style.display = "block";
    loginBtn.innerText = "ç®¡ç†è€…ç™»å‡º";
    loadSchedules();
    loadAnnouncement();
  }

  loginBtn.onclick = () => {
    if(!isAdmin){
      loginInputs.style.display = loginInputs.style.display === "none" ? "block" : "none";
    } else {
      // ç™»å‡º
      isAdmin = false;
      localStorage.removeItem("isAdmin");
      document.getElementById("admin").style.display = "none";
      loginBtn.innerText = "ç®¡ç†è€…ç™»å…¥";
      loadAnnouncement();
      loadSchedules();
    }
  };

  submitBtn.onclick = () => {
    const user = document.getElementById("adminUser").value.trim();
    const pass = document.getElementById("adminPass").value.trim();
    if(!user || !pass) return alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
    const hash = CryptoJS.SHA256(user + ":" + pass).toString();
    if(hash === ADMIN_HASH){
      isAdmin = true;
      localStorage.setItem("isAdmin","true"); // è¨˜éŒ„ç™»å…¥
      alert("âœ… ç®¡ç†è€…ç™»å…¥æˆåŠŸï¼");
      document.getElementById("admin").style.display = "block";
      loginBtn.innerText = "ç®¡ç†è€…ç™»å‡º";
      loginInputs.style.display = "none";
      loadSchedules();
      loadAnnouncement();
    } else {
      alert("âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
    }
  };

  // ===== ç®¡ç†å“¡å®˜è·é¸å–®æ§åˆ¶ =====
  const scheduleSelectAdmin = document.getElementById("scheduleSelectAdmin");
  const scheduleOtherInput = document.getElementById("scheduleOtherInput");
  scheduleSelectAdmin.addEventListener("change", ()=>{
    if(scheduleSelectAdmin.value === "å…¶ä»–"){
      scheduleOtherInput.style.display = "inline-block";
    } else {
      scheduleOtherInput.style.display = "none";
    }
  });

  // ===== å®˜è·ç›¸é—œ =====
  const scheduleSelect = document.getElementById("scheduleSelect");
  const deleteScheduleSelect = document.getElementById("deleteScheduleSelect");
  let currentSchedule = "";

  async function loadSchedules() {
    const snap = await db.ref("schedules").get();
    const data = snap.val() || {};
    const names = Object.keys(data).filter(n => n !== "A");
    if (names.length === 0) {
      scheduleSelect.innerHTML = `<option value="">å°šæœªå»ºç«‹ä»»ä½•å®˜è·</option>`;
      deleteScheduleSelect.innerHTML = `<option value="">å°šæœªå»ºç«‹ä»»ä½•å®˜è·</option>`;
      currentSchedule = "";
      document.getElementById("slots").innerHTML = "";
      return;
    }
    scheduleSelect.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join("");
    deleteScheduleSelect.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join("");
    if (!currentSchedule || !names.includes(currentSchedule)) currentSchedule = names[0];
    scheduleSelect.value = currentSchedule;
    loadSlotsAll();
  }

  scheduleSelect.addEventListener("change", () => {
    currentSchedule = scheduleSelect.value;
    loadSlotsAll();
  });

  async function loadSlotsAll() {
    if (!currentSchedule) return;
    const snap = await db.ref(`slots_${currentSchedule}`).once("value");
    const data = snap.val() || {};
    const area = document.getElementById("slots");
    area.innerHTML = "";

    const grouped = {};
    Object.keys(data).forEach(id => {
      const s = data[id];
      if (!grouped[s.date]) grouped[s.date] = [];
      grouped[s.date].push({...s, id});
    });

    const dates = Object.keys(grouped).sort();
    if (dates.length === 0) { area.innerHTML="<p style='color:#888'>æ­¤å®˜è·å°šç„¡æ™‚æ®µ</p>"; return; }

    const now = new Date();

    dates.forEach(date => {
      const title = document.createElement("div");
      title.className = "date-title";
      title.innerText = date;
      area.appendChild(title);

      grouped[date].sort((a,b)=>a.hour-b.hour).forEach(s=>{
        const div=document.createElement("div");
        div.className="slot"+(s.name?" taken":"");

        const span=document.createElement("span");
        let text = `${s.hour}:00-${s.hour+1}:00 `;
        text += s.name ? `â†’ ${s.name}`:"(ç©º)";
        span.innerText = text;
        div.appendChild(span);

        if(s.done && !isAdmin){
          const statusSpan=document.createElement("span");
          statusSpan.style.marginLeft="8px";
          statusSpan.style.color="green";
          statusSpan.innerText=" âœ… å·²å®‰æ’";
          div.appendChild(statusSpan);
        }

        span.onclick = async () => {
          const user = document.getElementById("name").value.trim();
          const pwd = document.getElementById("password").value.trim();
          if(!user) return alert("è«‹è¼¸å…¥åç¨±");

          if(!isAdmin){
            const [y,m,d] = s.date.split("-").map(Number);
            const slotEndTaiwan = new Date(Date.UTC(y, m-1, d, s.hour+1-8, 0,0));
            if(slotEndTaiwan.getTime() <= now.getTime()) return alert("æ­¤æ™‚æ®µå·²éï¼Œç„¡æ³•é¸æ“‡");
          }

          if(!isAdmin){
            if(s.name){
              if(user!==s.name) return alert("æ­¤æ™‚æ®µå·²è¢«å…¶ä»–ä½¿ç”¨è€…ç™»è¨˜ï¼Œç„¡æ³•ä¿®æ”¹");
              if(s.password && pwd!==s.password) return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•ä¿®æ”¹è‡ªå·±çš„æ™‚æ®µ");
            }
          }

          let updates = {};
          if(s.name===user){ updates={name:"",password:"",done:false}; }
          else{ updates={name:user,password:pwd}; }

          await db.ref(`slots_${currentSchedule}/${s.id}`).update(updates);
          loadSlotsAll();
        };

        if(isAdmin){
          const delBtn=document.createElement("button");
          delBtn.className="admin-btn";
          delBtn.innerText="åˆªé™¤æ™‚æ®µ";
          delBtn.onclick=async e=>{
            e.stopPropagation();
            await db.ref(`slots_${currentSchedule}/${s.id}`).remove();
            loadSlotsAll();
          };
          div.appendChild(delBtn);

          if(s.name){
            const editBtn=document.createElement("button");
            editBtn.className="admin-btn";
            editBtn.innerText="ç·¨è¼¯åå­—";
            editBtn.onclick=async e=>{
              e.stopPropagation();
              const newName=prompt("ä¿®æ”¹åå­—ï¼ˆæ¸…ç©ºè«‹ç•™ç©ºï¼‰",s.name);
              if(newName!==null){
                let updates={name:newName.trim()};
                if(newName.trim()===""){ updates={name:"",password:"",done:false}; }
                await db.ref(`slots_${currentSchedule}/${s.id}`).update(updates);
                loadSlotsAll();
              }
            };
            div.appendChild(editBtn);

            const pwdSpan=document.createElement("span");
            pwdSpan.className="pwd-span";
            pwdSpan.innerText = `å¯†ç¢¼: ${s.password||"(ç©º)"}`;
            div.appendChild(pwdSpan);

            const chk=document.createElement("input");
            chk.type="checkbox";
            chk.checked=s.done||false;
            chk.onchange=async ()=>{
              await db.ref(`slots_${currentSchedule}/${s.id}`).update({done:chk.checked});
              loadSlotsAll();
            };
            div.appendChild(chk);

            const lbl=document.createElement("span");
            lbl.style.marginLeft="8px";
            lbl.innerText = chk.checked ? "âœ… å·²å®‰æ’" : "æœªå®‰æ’";
            div.appendChild(lbl);
          }
        }

        area.appendChild(div);
      });
    });
  }

  // ===== ç®¡ç†å“¡å»ºç«‹æ™‚æ®µ =====
  document.getElementById("make").onclick = async ()=>{
    if(!isAdmin) return alert("âŒ è«‹å…ˆç™»å…¥ç®¡ç†è€…");
    const day = document.getElementById("day").value;
    const s = parseInt(document.getElementById("start").value);
    const e = parseInt(document.getElementById("end").value);

    let sched = scheduleSelectAdmin.value;
    if(sched === "å…¶ä»–"){
      sched = scheduleOtherInput.value.trim();
      if(!sched) return alert("è«‹è¼¸å…¥è‡ªè¨‚å®˜è·åç¨±");
    }

    if(!day || isNaN(s) || isNaN(e)) return alert("è«‹å¡«å®Œæ•´");

    const updates = {};
    for(let h=s; h<e; h++){
      updates[`${day}_${h}`]={date:day,hour:h,name:"",done:false,password:""};
    }
    await db.ref(`slots_${sched}`).update(updates);
    await db.ref(`schedules/${sched}`).set(true);
    alert(`âœ… å·²å»ºç«‹ ${sched} çš„æ™‚æ®µ`);
    currentSchedule = sched;
    loadSchedules();
  };

  // ===== åˆªé™¤å®˜è· =====
  document.getElementById("deleteSchedule").onclick=async ()=>{
    if(!isAdmin) return alert("âŒ è«‹å…ˆç™»å…¥ç®¡ç†è€…");
    const delSched = deleteScheduleSelect.value;
    if(!delSched) return alert("è«‹å…ˆé¸æ“‡å®˜è·");
    if(!confirm(`âš ï¸ ç¢ºå®šåˆªé™¤ã€Œ${delSched}ã€å®˜è·çš„æ‰€æœ‰æ™‚æ®µå—ï¼Ÿ`)) return;
    await db.ref(`slots_${delSched}`).remove();
    await db.ref(`schedules/${delSched}`).remove();
    alert(`âœ… å·²åˆªé™¤ã€Œ${delSched}ã€å®˜è·åŠå…¶æ™‚æ®µ`);
    currentSchedule="";
    loadSchedules();
  };

  document.getElementById("refresh").onclick=()=>loadSlotsAll();
  loadSchedules();
});
</script>
</body>
</html>

