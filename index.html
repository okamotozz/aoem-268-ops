<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>268å®˜è·æ’ç¨‹è¡¨</title>
  <style>
    body { font-family:"Microsoft JhengHei", sans-serif; background:#f6f6fa; padding:20px; }
    .wrap { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
    .slot { background:#f0f3ff; border-radius:8px; padding:10px; margin:6px; display:flex; justify-content: space-between; align-items:center; cursor:pointer; }
    .slot.taken { background:#ffe5e5; color:#666; }
    input,button,select,textarea { padding:8px; margin:4px; }
    .admin-btn { background:#ffcccc; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; margin-left:4px; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>268å®˜è·æ’ç¨‹è¡¨</h2>

  <!-- å…¬å‘Šå€ -->
  <div id="announcementArea" style="margin:20px 0; padding:10px; background:#fff3e0; border-radius:8px;">
    <h3>å…¬å‘Š</h3>
    <div id="announcementText" style="white-space:pre-wrap; color:#333;">è¼‰å…¥ä¸­...</div>

    <!-- ç®¡ç†å“¡ç·¨è¼¯å…¬å‘Š -->
    <div id="announcementAdmin" style="margin-top:10px; display:none;">
      <textarea id="announcementInput" rows="3" style="width:100%; padding:6px;"></textarea>
      <button id="saveAnnouncement" style="margin-top:6px; padding:6px 12px; border-radius:6px; background:#ffcc80; border:none; cursor:pointer;">å„²å­˜å…¬å‘Š</button>
    </div>
  </div>

  <!-- ä½¿ç”¨è€…è¼¸å…¥åå­—èˆ‡å¯†ç¢¼ -->
  <div>
    <input id="name" placeholder="è«‹è¼¸å…¥ä½ çš„éŠæˆ²åç¨±">
  </div>
  <div>
    <input id="password" placeholder="å¯é¸æ“‡è¨­å®šå¯†ç¢¼ä¿è­·æ­¤æ™‚æ®µ" type="password">
  </div>
  <button id="refresh">ç¢ºèªéŠæˆ²åç¨±</button>

  <!-- é¸æ“‡æ—¥æœŸ -->
  <select id="dateSelect"></select>

  <!-- æ™‚æ®µåˆ—è¡¨ -->
  <div id="slots"></div>

  <!-- ç®¡ç†å“¡å€ -->
  <div id="admin" style="margin-top:20px; background:#fff6e0; padding:10px; border-radius:8px;">
    <h3>ç®¡ç†å“¡å°ˆå€</h3>
    <input id="day" type="date">
    <input id="start" type="number" placeholder="é–‹å§‹å°æ™‚ (0-23)">
    <input id="end" type="number" placeholder="çµæŸå°æ™‚ (1-24)">
    <button id="make">å»ºç«‹æ™‚æ®µ</button>
  </div>
</div>

<div style="text-align:center; margin-top:20px; font-size:12px; color:#888;">
  ç¶²é ä½œè€…ï¼šDarkIrene
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/************ åœ¨é€™è£¡è²¼ä½ çš„ Firebase è¨­å®š ************/
const firebaseConfig = {
  apiKey: "AIzaSyBqUOjnXN-bp7OXJoQevS9-c0pnZxRU_B0",
  authDomain: "test-d07d4.firebaseapp.com",
  databaseURL: "https://test-d07d4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test-d07d4",
  storageBucket: "test-d07d4.firebasestorage.app",
  messagingSenderId: "442419315645",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ç®¡ç†å“¡ ID
const params = new URLSearchParams(location.search);
const isAdmin = params.get("admin") === "268admin"; // å¯æ”¹æˆä½ è‡ªå·±çš„ç®¡ç†å“¡ ID
document.getElementById("admin").style.display = isAdmin ? "block" : "none";

// å…¬å‘Šå€
const announcementRef = db.ref("announcement");

// é¡¯ç¤ºå…¬å‘Š
async function loadAnnouncement() {
  const snap = await announcementRef.once("value");
  const text = snap.val() || "ç›®å‰æ²’æœ‰å…¬å‘Š";
  document.getElementById("announcementText").innerText = text;

  if(isAdmin){
    document.getElementById("announcementAdmin").style.display = "block";
    document.getElementById("announcementInput").value = text;
  }
}

if(isAdmin){
  document.getElementById("saveAnnouncement").onclick = async () => {
    const text = document.getElementById("announcementInput").value.trim();
    await announcementRef.set(text);
    alert("âœ… å…¬å‘Šå·²æ›´æ–°ï¼");
    loadAnnouncement();
  };
}

// æ—¥æœŸèˆ‡æ™‚æ®µ
async function loadDates(){
  const snap = await db.ref("slots").once("value");
  const data = snap.val()||{};
  const dates = [...new Set(Object.values(data).map(d=>d.date))];
  const sel = document.getElementById("dateSelect");
  sel.innerHTML = dates.map(d=>`<option>${d}</option>`).join("");
  if (dates[0]) loadSlots(dates[0]);
  sel.onchange = ()=>loadSlots(sel.value);
}

async function loadSlots(date){
  const nameInput = document.getElementById("name").value.trim();
  const pwdInput = document.getElementById("password").value.trim();
  const snap = await db.ref("slots").orderByChild("date").equalTo(date).once("value");
  const data = snap.val()||{};
  const area = document.getElementById("slots");
  area.innerHTML = "";

  Object.keys(data).sort((a,b)=>data[a].hour-data[b].hour).forEach(id=>{
    const s = data[id];
    const div = document.createElement("div");
    div.className = "slot"+(s.name?" taken":"");

    // æ™‚æ®µæ–‡å­—
    const span = document.createElement("span");
    span.innerText = `${s.hour}:00-${s.hour+1}:00 ` + (s.name?`â†’ ${s.name}`:"(ç©º)");
    div.appendChild(span);

    // ä½¿ç”¨è€…é»é¸é ç´„
    span.onclick = async () => {
      const name = document.getElementById("name").value.trim();
      const pwdInput = document.getElementById("password").value.trim();
      if(!name) return alert("è«‹å…ˆè¼¸å…¥éŠæˆ²åç¨±");
      if(s.done) return alert("æ­¤æ™‚æ®µå·²è¢«ç®¡ç†å“¡æ¨™è¨˜ç‚ºå·²å®‰æ’ï¼Œç„¡æ³•æ›´æ”¹");
      const now = new Date();
      const slotDate = new Date(s.date);
      slotDate.setHours(s.hour,0,0,0);
      if(now >= slotDate) return alert("æ­¤æ™‚æ®µå·²éï¼Œç„¡æ³•é¸æ“‡");

      if(s.name){
        if(s.name !== name){
          if(s.password){
            if(pwdInput !== s.password) return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•ä¿®æ”¹ä»–äººçš„æ™‚æ®µ");
          } else return alert("æ­¤æ™‚æ®µå·²è¢«å…¶ä»–ä½¿ç”¨è€…ç™»è¨˜ï¼Œç„¡æ³•ä¿®æ”¹");
        } else {
          if(s.password && pwdInput !== s.password){
            return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•ä¿®æ”¹è‡ªå·±çš„æ™‚æ®µ");
          }
        }
      }

      let updates = {};
      if(s.name === name){ 
        updates = {name: "", password: ""};
      } else {
        updates = {name: name, password: pwdInput};
      }
      await db.ref("slots/"+id).update(updates);
      loadSlots(date);
    };

    // ç®¡ç†å“¡åŠŸèƒ½
    if(isAdmin){
      const delBtn = document.createElement("button");
      delBtn.className = "admin-btn";
      delBtn.innerText = "åˆªé™¤æ™‚æ®µ";
      delBtn.onclick = async (e)=>{
        e.stopPropagation();
        if(!confirm(`ç¢ºå®šåˆªé™¤ ${s.hour}:00-${s.hour+1}:00 çš„æ™‚æ®µå—ï¼Ÿ`)) return;
        await db.ref("slots/"+id).remove();
        loadSlots(date);
      };
      div.appendChild(delBtn);

      if(s.name){
        const editBtn = document.createElement("button");
        editBtn.className = "admin-btn";
        editBtn.innerText = "ç·¨è¼¯åå­—";
        editBtn.onclick = async (e)=>{
          e.stopPropagation();
          const newName = prompt("ä¿®æ”¹åå­—ï¼ˆæ¸…ç©ºè«‹ç•™ç©ºï¼‰", s.name);
          if(newName !== null){
            const updates = {name: newName.trim()};
            if(newName.trim() === "") updates.password = "";
            await db.ref("slots/"+id).update(updates);
            loadSlots(date);
          }
        };
        div.appendChild(editBtn);

        const doneCheckbox = document.createElement("input");
        doneCheckbox.type = "checkbox";
        doneCheckbox.checked = s.done || false;
        doneCheckbox.style.marginLeft = "10px";
        doneCheckbox.onchange = async () => {
          await db.ref("slots/"+id).update({done: doneCheckbox.checked});
          loadSlots(date);
        };
        div.appendChild(doneCheckbox);

        const label = document.createElement("span");
        label.innerText = " å·²å®‰æ’";
        div.appendChild(label);

        if(s.password){
          const pwdSpan = document.createElement("span");
          pwdSpan.innerText = ` å¯†ç¢¼: ${s.password}`;
          pwdSpan.style.marginLeft = "8px";
          pwdSpan.style.color = "#555";
          div.appendChild(pwdSpan);
        }
      }
    }

    if(s.name && s.done){
      const doneSpan = document.createElement("span");
      doneSpan.innerText = " âœ… å·²å®‰æ’";
      doneSpan.style.marginLeft = "8px";
      div.appendChild(doneSpan);
    }

    area.appendChild(div);
  });
}

// åˆ·æ–°æŒ‰éˆ•
document.getElementById("refresh").onclick = ()=>loadDates();

// å»ºç«‹æ™‚æ®µï¼ˆç®¡ç†å“¡ï¼‰
if(isAdmin){
  document.getElementById("make").onclick = async () => {
    const d = document.getElementById("day").value;
    const s = parseInt(document.getElementById("start").value);
    const e = parseInt(document.getElementById("end").value);
    if(!d || isNaN(s) || isNaN(e)) return alert("è«‹å¡«å®Œæ•´");
    const updates = {};
    for(let h=s; h<e; h++){
      updates[`slots/${d}_${h}`] = {date:d, hour:h, name:"", done:false, password:""};
    }
    await db.ref().update(updates);
    alert("âœ… å·²å»ºç«‹æ™‚æ®µï¼");
    loadDates();
  };

  const delAllBtn = document.createElement("button");
  delAllBtn.innerText = "åˆªé™¤æ­¤æ—¥æœŸçš„æ‰€æœ‰æ™‚æ®µ";
  delAllBtn.style.marginLeft = "10px";
  delAllBtn.style.padding = "6px";
  delAllBtn.style.borderRadius = "6px";
  delAllBtn.style.background = "#ffcccc";
  delAllBtn.style.border = "none";
  delAllBtn.style.cursor = "pointer";
  document.getElementById("admin").appendChild(delAllBtn);

  delAllBtn.onclick = async () => {
    const d = document.getElementById("day").value;
    if(!d) return alert("è«‹å…ˆé¸æ“‡æ—¥æœŸ");
    if(!confirm(`ç¢ºå®šè¦åˆªé™¤ ${d} çš„æ‰€æœ‰æ™‚æ®µå—ï¼Ÿ`)) return;
    const snap = await db.ref("slots").orderByChild("date").equalTo(d).once("value");
    const data = snap.val() || {};
    const updates = {};
    Object.keys(data).forEach(id => { updates[`slots/${id}`] = null; });
    await db.ref().update(updates);
    alert(`ğŸ—‘ï¸ å·²åˆªé™¤ ${d} çš„æ‰€æœ‰æ™‚æ®µ`);
    loadDates();
  };
}

loadDates();
loadAnnouncement();
</script>
</body>
</html>
