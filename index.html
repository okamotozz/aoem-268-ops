<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>268å®˜è·æ’ç¨‹è¡¨</title>
  <style>
    body { font-family:"Microsoft JhengHei", sans-serif; background:#f6f6fa; padding:20px; }
    .wrap { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
    .slot { background:#f0f3ff; border-radius:8px; padding:10px; margin:6px; display:flex; justify-content: space-between; align-items:center; cursor:pointer; }
    .slot.taken { background:#ffe5e5; color:#666; }
    input,button,select { padding:8px; margin:4px; }
    .admin-btn { background:#ffcccc; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; margin-left:4px; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>268å®˜è·æ’ç¨‹è¡¨</h2>


  <div id="announcement" style="background:#fff3c6; padding:10px; border-radius:6px; margin-bottom:10px; cursor:default;">
  æ­¡è¿ä½¿ç”¨æ’ç­è¡¨ï¼Œå…¬å‘Šæ–‡å­—
</div>



  <!-- ä½¿ç”¨è€…è¼¸å…¥åå­—èˆ‡å¯†ç¢¼ -->
  <div>
    <input id="name" placeholder="è«‹è¼¸å…¥ä½ çš„éŠæˆ²åç¨±">
  </div>
  <div>
    <input id="password" placeholder="å¯é¸æ“‡è¨­å®šå¯†ç¢¼ä¿è­·æ­¤æ™‚æ®µ" type="password">
  </div>
  <button id="refresh">ç¢ºèªéŠæˆ²åç¨±</button>

  <!-- é¸æ“‡æ—¥æœŸ -->
  <select id="dateSelect"></select>

  <!-- æ™‚æ®µåˆ—è¡¨ -->
  <div id="slots"></div>

  <!-- ç®¡ç†å“¡å€ -->
  <div id="admin" style="margin-top:20px; background:#fff6e0; padding:10px; border-radius:8px;">
    <h3>ç®¡ç†å“¡å°ˆå€</h3>
    <input id="day" type="date">
    <input id="start" type="number" placeholder="é–‹å§‹å°æ™‚ (0-23)">
    <input id="end" type="number" placeholder="çµæŸå°æ™‚ (1-24)">
    <button id="make">å»ºç«‹æ™‚æ®µ</button>
  </div>
</div>

</div> <!-- wrap çµæŸ -->

<div style="text-align:center; margin-top:20px; font-size:12px; color:#888;">
  ç¶²é ä½œè€…ï¼šDarkIrene
</div>

</body>
</html>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/************ åœ¨é€™è£¡è²¼ä½ çš„ Firebase è¨­å®š ************/
const firebaseConfig = {
  apiKey: "AIzaSyBqUOjnXN-bp7OXJoQevS9-c0pnZxRU_B0",
  authDomain: "test-d07d4.firebaseapp.com",
  databaseURL: "https://test-d07d4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test-d07d4",
  storageBucket: "test-d07d4.firebasestorage.app",
  messagingSenderId: "442419315645",
};
/****************************************************/
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ç®¡ç†å“¡ ID
const params = new URLSearchParams(location.search);
const isAdmin = params.get("admin") === "268admin"; // å¯æ”¹æˆä½ è‡ªå·±çš„ç®¡ç†å“¡ ID
document.getElementById("admin").style.display = isAdmin ? "block" : "none";

async function loadDates(){
  const snap = await db.ref("slots").once("value");
  const data = snap.val()||{};
  const dates = [...new Set(Object.values(data).map(d=>d.date))];
  const sel = document.getElementById("dateSelect");
  sel.innerHTML = dates.map(d=>`<option>${d}</option>`).join("");
  if (dates[0]) loadSlots(dates[0]);
  sel.onchange = ()=>loadSlots(sel.value);
}

async function loadSlots(date){
  const nameInput = document.getElementById("name").value.trim();
  const pwdInput = document.getElementById("password").value.trim();
  const snap = await db.ref("slots").orderByChild("date").equalTo(date).once("value");
  const data = snap.val()||{};
  const area = document.getElementById("slots");
  area.innerHTML = "";

  Object.keys(data).sort((a,b)=>data[a].hour-data[b].hour).forEach(id=>{
    const s = data[id];
    const div = document.createElement("div");
    div.className = "slot"+(s.name?" taken":"");

    // æ™‚æ®µæ–‡å­—
    const span = document.createElement("span");
    span.innerText = `${s.hour}:00-${s.hour+1}:00 ` + (s.name?`â†’ ${s.name}`:"(ç©º)");
    div.appendChild(span);

    // ä½¿ç”¨è€…é»é¸é ç´„
    span.onclick = async () => {
      const name = document.getElementById("name").value.trim();
      const pwdInput = document.getElementById("password").value.trim();
      if(!name) return alert("è«‹å…ˆè¼¸å…¥éŠæˆ²åç¨±");

      // é™åˆ¶ 1ï¼šç®¡ç†å“¡å·²å‹¾é¸ã€Œå·²å®‰æ’ã€ä¸èƒ½é¸
      if(s.done) return alert("æ­¤æ™‚æ®µå·²è¢«ç®¡ç†å“¡æ¨™è¨˜ç‚ºå·²å®‰æ’ï¼Œç„¡æ³•æ›´æ”¹");

      // é™åˆ¶ 2ï¼šæ™‚æ®µå·²éï¼Œä¸èƒ½é¸
      const now = new Date();
      const slotDate = new Date(s.date);
      slotDate.setHours(s.hour,0,0,0);
      if(now >= slotDate) return alert("æ­¤æ™‚æ®µå·²éï¼Œç„¡æ³•é¸æ“‡");

      // å¯†ç¢¼ä¿è­·åˆ¤æ–·
      if(s.name){ // è‹¥å·²æœ‰ä½¿ç”¨è€…ç™»è¨˜
        if(s.name !== name){ // åå­—ä¸åŒ
          if(s.password){ // å·²è¨­å®šå¯†ç¢¼
            if(pwdInput !== s.password) return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•ä¿®æ”¹ä»–äººçš„æ™‚æ®µ");
          } else {
            return alert("æ­¤æ™‚æ®µå·²è¢«å…¶ä»–ä½¿ç”¨è€…ç™»è¨˜ï¼Œç„¡æ³•ä¿®æ”¹");
          }
        } else { // åå­—ç›¸åŒ
          if(s.password && pwdInput !== s.password){
            return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•ä¿®æ”¹è‡ªå·±çš„æ™‚æ®µ");
          }
        }
      }

      // é€šéæª¢æŸ¥ï¼Œæ›´æ–°åå­—èˆ‡å¯†ç¢¼
      let updates = {};
if(s.name === name){ 
    // ä½¿ç”¨è€…é»è‡ªå·±åå­—å–æ¶ˆ â†’ æ¸…ç©ºåå­—èˆ‡å¯†ç¢¼
    updates = {name: "", password: ""};
} else {
    // ç™»è¨˜æˆ–ä¿®æ”¹å¯†ç¢¼
    updates = {name: name, password: pwdInput};
}
await db.ref("slots/"+id).update(updates);

      loadSlots(date);
    };

    // ç®¡ç†å“¡åŠŸèƒ½
    if(isAdmin){
      // åˆªé™¤æ™‚æ®µ
      const delBtn = document.createElement("button");
      delBtn.className = "admin-btn";
      delBtn.innerText = "åˆªé™¤æ™‚æ®µ";
      delBtn.onclick = async (e)=>{
        e.stopPropagation();
        if(!confirm(`ç¢ºå®šåˆªé™¤ ${s.hour}:00-${s.hour+1}:00 çš„æ™‚æ®µå—ï¼Ÿ`)) return;
        await db.ref("slots/"+id).remove();
        loadSlots(date);
      };
      div.appendChild(delBtn);

      // ç·¨è¼¯ / æ¸…ç©ºåå­—
      if(s.name){
        const editBtn = document.createElement("button");
editBtn.className = "admin-btn";
editBtn.innerText = "ç·¨è¼¯åå­—";
editBtn.onclick = async (e)=>{
  e.stopPropagation();
  const newName = prompt("ä¿®æ”¹åå­—ï¼ˆæ¸…ç©ºè«‹ç•™ç©ºï¼‰", s.name);
  if(newName !== null){
    // å¦‚æœæ¸…ç©ºåå­—ï¼ŒåŒæ™‚æ¸…ç©ºå¯†ç¢¼
    const updates = {name: newName.trim()};
    if(newName.trim() === "") updates.password = "";
    await db.ref("slots/"+id).update(updates);
    loadSlots(date);
  }
};

        div.appendChild(editBtn);
      }

      // å·²å®‰æ’å‹¾é¸
      if(s.name){
        const doneCheckbox = document.createElement("input");
        doneCheckbox.type = "checkbox";
        doneCheckbox.checked = s.done || false;
        doneCheckbox.style.marginLeft = "10px";
        doneCheckbox.onchange = async () => {
          await db.ref("slots/"+id).update({done: doneCheckbox.checked});
          loadSlots(date);
        };
        div.appendChild(doneCheckbox);

        const label = document.createElement("span");
        label.innerText = " å·²å®‰æ’";
        div.appendChild(label);
      }

      // é¡¯ç¤ºä½¿ç”¨è€…å¯†ç¢¼
      if(s.password){
        const pwdSpan = document.createElement("span");
        pwdSpan.innerText = ` å¯†ç¢¼: ${s.password}`;
        pwdSpan.style.marginLeft = "8px";
        pwdSpan.style.color = "#555";
        div.appendChild(pwdSpan);
      }
    }

    // é¡¯ç¤ºä½¿ç”¨è€…å·²å®‰æ’
    if(s.name && s.done){
      const doneSpan = document.createElement("span");
      doneSpan.innerText = " âœ… å·²å®‰æ’";
      doneSpan.style.marginLeft = "8px";
      div.appendChild(doneSpan);
    }

    area.appendChild(div);
  });
}

// åˆ·æ–°æŒ‰éˆ•
document.getElementById("refresh").onclick = ()=>loadDates();

// å»ºç«‹æ™‚æ®µï¼ˆç®¡ç†å“¡ï¼‰
if(isAdmin){
  document.getElementById("make").onclick = async () => {
    const d = document.getElementById("day").value;
    const s = parseInt(document.getElementById("start").value);
    const e = parseInt(document.getElementById("end").value);
    if(!d || isNaN(s) || isNaN(e)) return alert("è«‹å¡«å®Œæ•´");
    const updates = {};
    for(let h=s; h<e; h++){
      updates[`slots/${d}_${h}`] = {date:d, hour:h, name:"", done:false, password:""};
    }
    await db.ref().update(updates);
    alert("âœ… å·²å»ºç«‹æ™‚æ®µï¼");
    loadDates();
  };

  // åˆªé™¤æ•´å¤©æ™‚æ®µ
  const delAllBtn = document.createElement("button");
  delAllBtn.innerText = "åˆªé™¤æ­¤æ—¥æœŸçš„æ‰€æœ‰æ™‚æ®µ";
  delAllBtn.style.marginLeft = "10px";
  delAllBtn.style.padding = "6px";
  delAllBtn.style.borderRadius = "6px";
  delAllBtn.style.background = "#ffcccc";
  delAllBtn.style.border = "none";
  delAllBtn.style.cursor = "pointer";
  document.getElementById("admin").appendChild(delAllBtn);

  delAllBtn.onclick = async () => {
    const d = document.getElementById("day").value;
    if(!d) return alert("è«‹å…ˆé¸æ“‡æ—¥æœŸ");
    if(!confirm(`ç¢ºå®šè¦åˆªé™¤ ${d} çš„æ‰€æœ‰æ™‚æ®µå—ï¼Ÿ`)) return;
    const snap = await db.ref("slots").orderByChild("date").equalTo(d).once("value");
    const data = snap.val() || {};
    const updates = {};
    Object.keys(data).forEach(id => { updates[`slots/${id}`] = null; });
    await db.ref().update(updates);
    alert(`ğŸ—‘ï¸ å·²åˆªé™¤ ${d} çš„æ‰€æœ‰æ™‚æ®µ`);
    loadDates();
  };

const announcementDiv = document.getElementById("announcement");

// å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé»æ“Šå…¬å‘Šå¯ä»¥ç·¨è¼¯
if(isAdmin){
  announcementDiv.style.cursor = "pointer";
  announcementDiv.title = "é»æ“Šç·¨è¼¯å…¬å‘Š";

  announcementDiv.onclick = async () => {
    const newText = prompt("è«‹è¼¸å…¥æ–°çš„å…¬å‘Šæ–‡å­—ï¼š", announcementDiv.innerText);
    if(newText !== null){
      await db.ref("announcement").set(newText);
      announcementDiv.innerText = newText;
    }
  };
}

// è®€å–å…¬å‘Šæ–‡å­—
db.ref("announcement").on("value", snap => {
  const val = snap.val() || "æ­¡è¿ä½¿ç”¨æ’ç­è¡¨ï¼Œå…¬å‘Šæ–‡å­—";
  announcementDiv.innerText = val;
});


}

loadDates();
</script>
</body>
</html>
